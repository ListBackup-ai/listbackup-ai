# ListBackup.ai v2 Backend

Modern, scalable backend architecture for ListBackup.ai using AWS Serverless technologies.

## üèóÔ∏è Architecture

### Language Separation
- **Node.js**: API endpoints, authentication, real-time features
- **Python**: Data processing, backup operations, analytics, AI/ML

### Service Structure
```
backend/
‚îú‚îÄ‚îÄ nodejs/                 # Node.js API services
‚îÇ   ‚îú‚îÄ‚îÄ serverless-core.yml    # DynamoDB tables, S3, SQS, EventBridge
‚îÇ   ‚îú‚îÄ‚îÄ serverless-auth.yml    # Authentication & user management
‚îÇ   ‚îú‚îÄ‚îÄ serverless-api.yml     # Main API endpoints
‚îÇ   ‚îî‚îÄ‚îÄ serverless-analytics.yml # Analytics & reporting
‚îú‚îÄ‚îÄ python/                 # Python processing services
‚îÇ   ‚îú‚îÄ‚îÄ serverless-backup-processors.yml  # Backup & file processing
‚îÇ   ‚îî‚îÄ‚îÄ serverless-data-analysis.yml      # Data insights & AI
‚îú‚îÄ‚îÄ shared/                 # Shared configurations
‚îÇ   ‚îú‚îÄ‚îÄ configs/            # API and service configs
‚îÇ   ‚îî‚îÄ‚îÄ schemas/            # TypeScript type definitions
‚îî‚îÄ‚îÄ scripts/                # Deployment automation
    ‚îî‚îÄ‚îÄ deploy.sh           # Unified deployment script
```

## üóÑÔ∏è Data Architecture

### DynamoDB Tables (prefix: `listbackup-{stage}-`)
- **users**: User accounts and authentication
- **accounts**: Account settings and billing
- **sources**: Connected data sources (Google Drive, Dropbox, etc.)
- **jobs**: Backup job definitions and schedules
- **runs**: Backup execution instances
- **files**: File metadata and indexing
- **activity**: Audit logs and system events
- **oauth-states**: OAuth flow state management
- **api-keys**: Integration API keys
- **analytics-aggregates**: Pre-computed analytics data
- **reports**: Generated reports

### Storage
- **S3 Bucket**: `listbackup-data-{stage}` for backed up files
- **Versioning**: Enabled with intelligent tiering
- **Encryption**: AES-256 server-side encryption

### Messaging
- **Job Queue**: `listbackup-job-queue-{stage}` for backup orchestration
- **Data Queue**: `listbackup-data-queue-{stage}` for file processing
- **EventBridge**: `listbackup-events-{stage}` for real-time events

## üîë Environment Variables

### Required SSM Parameters
```bash
/listbackup/jwt-secret           # JWT signing key
/listbackup/jwt-refresh-secret   # JWT refresh token key
/listbackup/cors-origin          # Frontend origin URL
/listbackup/ses-from-email       # Email sender address
/listbackup/openai-api-key       # OpenAI API key (optional)
```

### Auto-generated by Cognito
```bash
/listbackup/cognito-user-pool-id # Created by auth service
/listbackup/cognito-client-id    # Created by auth service
```

## üöÄ Deployment

### Prerequisites
```bash
# Install dependencies
npm install -g serverless
pip install serverless-python-requirements

# Configure AWS credentials
aws configure

# Verify access
aws sts get-caller-identity
```

### Deploy All Services
```bash
# Main environment
./scripts/deploy.sh main all

# Production environment
./scripts/deploy.sh prod all
```

### Deploy Specific Services
```bash
# Deploy only Node.js services
./scripts/deploy.sh main nodejs

# Deploy only Python services
./scripts/deploy.sh main python

# Deploy only core infrastructure
./scripts/deploy.sh main core
```

## üîß Development

### Local Development
```bash
# Start Node.js services locally
cd nodejs
npm install
serverless offline --config serverless-api.yml

# Python development
cd python
pip install -r requirements.txt
# Use serverless-offline-python or deploy to AWS for testing
```

### Adding New Endpoints
1. Add function definition to appropriate `serverless-*.yml`
2. Create handler file in `src/handlers/`
3. Update TypeScript types in `shared/schemas/`
4. Deploy with `./scripts/deploy.sh main [service]`

## üìä Monitoring

### CloudWatch Dashboards
- `listbackup-v2-system-{stage}`: System-wide metrics
- `listbackup-backup-processors-{stage}-backup-performance`: Backup performance

### Key Metrics
- Lambda function duration and errors
- DynamoDB read/write capacity
- SQS queue depth and processing times
- S3 storage usage and costs

### Alarms
- High error rates (>5%)
- Function timeouts
- Queue backlogs
- Database throttling

## üîí Security

### Authentication
- JWT tokens with secure secrets
- Refresh token rotation
- MFA support via Cognito
- Password policy enforcement

### Authorization
- Role-based access control
- Resource-level permissions
- API key management for integrations

### Data Protection
- Encryption at rest (S3 + DynamoDB)
- Encryption in transit (HTTPS/TLS)
- VPC isolation for sensitive operations
- Regular security audits

## üîÑ Data Flow

### Backup Process
1. **API Request** ‚Üí Node.js API validates and queues job
2. **Job Queue** ‚Üí Python orchestrator processes job
3. **Source Integration** ‚Üí Python processors fetch data from sources
4. **File Processing** ‚Üí Compression, encryption, metadata extraction
5. **Storage** ‚Üí Upload to S3 with versioning
6. **Indexing** ‚Üí File metadata stored in DynamoDB
7. **Events** ‚Üí Real-time updates via EventBridge
8. **Analytics** ‚Üí Background aggregation and insights

### Real-time Updates
- EventBridge publishes events for all major operations
- WebSocket connections for live progress updates
- Activity feed for audit trails

## üß™ Testing

### Unit Tests
```bash
# Node.js
cd nodejs
npm test

# Python
cd python
pytest
```

### Integration Tests
```bash
# Deploy to test environment
./scripts/deploy.sh test all

# Run integration test suite
npm run test:integration
```

## üìù API Documentation

### Authentication Endpoints
- `POST /auth/login` - User login
- `POST /auth/register` - User registration  
- `POST /auth/refresh` - Token refresh
- `POST /auth/logout` - User logout

### Data Source Management
- `GET /sources` - List connected sources
- `POST /sources` - Connect new source
- `PUT /sources/{id}` - Update source settings
- `DELETE /sources/{id}` - Disconnect source

### Backup Management
- `GET /jobs` - List backup jobs
- `POST /jobs` - Create backup job
- `POST /jobs/{id}/run` - Run backup manually
- `GET /runs/{id}` - Get backup run status

### Data Browsing
- `GET /data/files` - Browse backed up files
- `POST /data/search` - Search files
- `POST /data/download` - Download files

### Analytics
- `GET /analytics/overview` - Account overview
- `GET /analytics/storage` - Storage analytics
- `POST /reports/generate` - Generate reports

## üÜò Troubleshooting

### Common Issues

**Deployment Fails**
```bash
# Check AWS credentials
aws sts get-caller-identity

# Verify Serverless installation
serverless --version

# Check CloudFormation limits
aws cloudformation describe-account-attributes
```

**Function Timeouts**
- Increase timeout in serverless.yml
- Optimize code for better performance
- Consider breaking into smaller functions

**DynamoDB Throttling**
- Check CloudWatch metrics
- Consider on-demand billing mode
- Optimize query patterns

**S3 Access Issues**
- Verify bucket policies
- Check IAM permissions
- Ensure bucket exists in correct region

### Logs and Debugging
```bash
# View function logs
serverless logs -f functionName --stage main

# Real-time log streaming
aws logs tail /aws/lambda/listbackup-api-main-getSources --follow

# CloudWatch Insights queries
aws logs start-query --log-group-name /aws/lambda/listbackup-api-main-getSources
```

## üìà Performance Optimization

### Best Practices
- Use Lambda provisioned concurrency for critical functions
- Implement connection pooling for database access
- Cache frequently accessed data
- Use S3 Transfer Acceleration for large files
- Optimize DynamoDB partition keys

### Cost Optimization
- Use S3 Intelligent Tiering
- Set appropriate DynamoDB capacity modes
- Monitor and optimize Lambda memory allocation
- Use CloudWatch cost monitoring

## üîÆ Future Enhancements

### Planned Features
- Real-time collaboration on backups
- Advanced AI-powered insights
- Multi-region disaster recovery
- Enhanced security scanning
- Third-party integrations (GitHub, Notion, etc.)

### Scalability Considerations
- Auto-scaling Lambda concurrency
- DynamoDB Global Tables for multi-region
- CDN for file downloads
- Event-driven architecture expansion